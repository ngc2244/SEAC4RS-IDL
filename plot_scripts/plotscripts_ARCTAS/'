; $Id: get_field_data_arctas.pro,v 1.6 2008/07/07 17:03:04 jaf Exp $
;-----------------------------------------------------------------------
;+
; NAME:
;        GET_FIELD_DATA_ARCTAS
;
; PURPOSE:
;        Read observations from the ARCTAS aircraft 
;        In addition to simplifying the file reading, this program
;        also defines common names for fields with awkward names
;
;        See NOTES (below) for where this function looks for the data
;
; CATEGORY:
;
; CALLING SEQUENCE:
;        Data = GET_FIELD_DATA_ARCTAS( Field, Platform, FlightDates[, Keywords] )
;
; INPUTS:
;        Field       - Name of observation variable. e.g. 'CO', 'DOY', 'ALTP'
;        Platform    - Name of Aircraft. Current options: 'DC8', 'P3B', '*'
;        FlightDates - Date of takeoff as YYYYMMDD or '*' for all ARCTAS flights.
;                      Also accepts wildcards e.g. '2008041*'
;
; KEYWORD PARAMETERS:
;        MinAvg      - If set, the returned Data are the 60s averages created
;                      by NASA. The default (MinAvg=0) is to use the observations 
;                      averaged over the GEOS-Chem grid and time resolution 
;                      (2x25 degrees, 15 minutes)
;
;        NoCities    - If set, the returned Data will not include observations
;                      near Fairbanks, Barrow, or Prudhoe Bay. The criteria are 
;                      currently <1.5 degrees from the site and <2 km altitude.
;
;        Troposphere - If set, the data include only troposphere, defined as
;                      [O3]/[CO] < 1.25
;
; OUTPUTS:
;        Data        - 1D array of all available data for the specified Field,
;                      Platform and FlightDates 
;
; SUBROUTINES:
;        READ_FILE_FIELD
;
; REQUIREMENTS:
;        NASA 60s merge files must be processed into IDL SAV files before
;        using this function.
;
; NOTES:
;        This function and its complement, GET_MODEL_DATA_ARCTAS assume
;        a particular directory structure:
;
;        !ARCTAS/
;           field_data/
;              DC8/
;                 merge_60s/        : NASA 60s merge files, converted to SAV
;                 merge_15m_2x25/   : Averages over GEOS-Chem grid and time
;              P3B/
;                 merge_60s/
;                 merge_15m_2x25/
;           gc_data/
;              nrt.v8-01-1.2x25/    : GEOS-Chem data with one file per
;                                     platform and flight date
;
;        !ARCTAS is a system variable defining the user's root ARCTAS data 
;        directory  e.g. ~/data/ARCTAS 
;
; EXAMPLE:
;
; MODIFICATION HISTORY:
;        cdh, 12 May 2008: VERSION 1.00
;        cdh, 12 May 2008: Added TROPOSPHERE keyword
;        cdh, 13 May 2008: Now when no data are available for the requested
;                          flight dates, the program returns NaN rather than 0
;        jaf,  7 Jul 2009: Added SOx reading
;
;-
; Copyright (C) 2008, Christopher Holmes, Harvard University
; This software is provided as is without any warranty whatsoever.
; It may be freely used, copied or distributed for non-commercial
; purposes.  This copyright notice must be kept with any copy of
; this software. If this software shall be used commercially or
; sold as part of a larger package, please contact the author.
; Bugs and comments should be directed to cdh@io.as.harvard.edu
; with subject "IDL routine get_field_data_arctas"
;-----------------------------------------------------------------------


;--------------------------------------------------------------
; READ_FILE_FIELD is a helper function that extracts one data array
;    from one file.
;
;--------------------------------------------------------------
function read_file_field, file, field, platform, ppt=ppt, nss=nss
 
  ;------
  ; Define common names for fields with awkward names
  ;------
  field = strlowcase( field )
 
  Case field of
    'alt': field = 'GPS_altitude'
    'lat': field = 'latitude'
    'lon': field = 'longitude'
    'co' : if strlowcase(platform) eq 'dc8' then $
	      field = 'carbon_monoxide_mixing_ratio'
    'ch4': field = 'methane_mixing_ratio' 
    'co2': field = 'co2_mixing_ratio'
    'hcn': field = 'hcn_cit'
    'fa_so4': field = 'fine_aerosol_sulfate'
    'so4': field = 'sulphate'
    'bc' : field = 'bc_mass_1013hpa_273k'
    'isop': field = 'isoprene'
    'aod350': field = 'aerosol_optical_depth_353_5nm'
    'aod380': field = 'aerosol_optical_depth_380_0nm'
    'aod450': field = 'aerosol_optical_depth_452_6nm'
    'aod500': field = 'aerosol_optical_depth_499_4nm'
    'aod520': field = 'aerosol_optical_depth_519_4nm'
    'aod605': field = 'aerosol_optical_depth_605_8nm'
    'aod675': field = 'aerosol_optical_depth_675_1nm'
    'rea_o1d':field = 'JO3_O2_O1D'
    'rea_no2':field = 'JNO2'
    else:
  endcase

  ; Open the Data file
  Restore, File

  ; Special Case for reading Day of Year 
  If field eq 'doy' then begin
 
      Print, 'Reading fields for DOY from file: '+file+' ...'
 
      ; Read the integer day of year
      s = 'jday = ' + Platform + '.jday' 
      status = Execute( s )  
 
      ; Read the time UTC
      s = 'utc = ' + Platform + '.utc' 
      status = Execute( s )  

      ; Form the fractional DOY from the integer part and fractional part 
      Data = jday + utc / (24. * 3600.) 
 
  ; Special Case for SOx
  endif else If field eq 'fa_sox' then begin
 
      Print, 'Reading fields for fa SOx from file: '+file+' ...'
 
      ; Read the integer day of year
      s = 'so2 = ' + Platform + '.so2' 
      status = Execute( s )  
 
      ; Read the time UTC
      s = 'fine_aerosol_sulfate = ' + Platform + '.fine_aerosol_sulfate' 
      status = Execute( s )  

      if (keyword_set(nss)) then begin
         s = 'sodium = ' + Platform + '.Na'
         status = Execute( s )
         ind = where(~finite(Na))
         sulfate[ind]=!Values.f_nan
         ; seasalt component is 0.252*sodium
         fine_aerosol_sulfate = fine_aerosol_sulfate - $
                    0.252 * sodium
      endif

      ; Sum for total SOx
      Data = so2 + fine_aerosol_sulfate
 
  ; Special Case for  fine_aerosol_sulfate
  endif else If field eq 'fine_aerosol_sulfate' then begin
 
      Print, 'Reading fields for fa SO4 from file: '+file+' ...'
 
      ; Read the time UTC
      s = 'fine_aerosol_sulfate = ' + Platform + '.fine_aerosol_sulfate' 
      status = Execute( s )  

      if (keyword_set(nss)) then begin
         s = 'sodium = ' + Platform + '.Na'
         status = Execute( s )
         ind = where(~finite(Na))
         sulfate[ind]=!Values.f_nan
         ; seasalt component is 0.252*sodium
         fine_aerosol_sulfate = fine_aerosol_sulfate - $
                    0.252 * sodium
      endif

      ; Convert units from ppt to nmole/m3
      if ~( keyword_set(ppt) ) then $
      data = ( 1.29 / 28.97 ) * fine_aerosol_sulfate $
      else data = fine_aerosol_sulfate

  ; Special Case for SOx
  endif else If field eq 'sox' then begin
 
      Print, 'Reading fields for SOx from file: '+file+' ...'
 
      ; Read the integer day of year
      s = 'so2 = ' + Platform + '.so2' 
      status = Execute( s )  
 
      ; Read the time UTC
      s = 'sulphate = ' + Platform + '.sulphate' 
      status = Execute( s )  

      if (keyword_set(nss)) then begin
         s = 'sodium = ' + Platform + '.Na'
         status = Execute( s )
         ind = where(~finite(Na))
         sulfate[ind]=!Values.f_nan
         ; seasalt component is 0.252*sodium, but Na is in pptv
         sulphate = sulphate - $
                    0.252 * ( ( 23.*1.29) / 28.97 ) * 1d-3 * sodium
      endif

      ; Convert units from ug/m3 to ppt for addition to SO2 in pptv
      sulphate = ( 28.97 / (96.*1.29) ) * 1d3 * sulphate

      ; Sum for total SOx
      Data = so2 + sulphate
 
  ; Special Case for AMS Sulfate (units of microgram/m3) 
  endif else If field eq 'sulphate' then begin

      Print, 'Reading fields for AMS Sulphate from file: '+file+' ...'

      s = 'sulphate = ' + Platform + '.Sulphate'

      status = Execute( s )

      if (keyword_set(nss)) then begin
         s = 'sodium = ' + Platform + '.Na'
         status = Execute( s )
         ind = where(~finite(Na))
         sulfate[ind]=!Values.f_nan
         ; seasalt component is 0.252*sodium, but Na is in pptv
         sulphate = sulphate - $
                    0.252 * ( ( 23.*1.29) / 28.97 ) * 1d-3 * sodium
      endif

      if (keyword_set(ppt)) then $
      ; Convert units from ug/m3 to ppt
      Data = ( 28.97 / (96.*1.29) ) * 1d3 * sulphate $
      else $
      ; Convert units from ug/m3 to nmole/m3
      Data = ( 1. / 96. ) * 1d3 * sulphate

  ; Special Case for AMS Ammonium (units of microgram/m3) 
  endif else If field eq 'nh4' then begin

      Print, 'Reading fields for AMS Ammonium from file: '+file+' ...'

      s = 'ammonium = ' + Platform + '.Ammonium'

      status = Execute( s )

      if (keyword_set(ppt)) then $
      ; Convert units from ug/m3 to ppt
      Data = ( 28.97 / (18.*1.29) ) * 1d3 * ammonium $
      else $
      ; Convert units from ug/m3 to nmole/m3
      Data = ( 1. / 18. ) * 1d3 * ammonium

  ; Special Case for AMS Nitrate (units of microgram/m3) 
  endif else If field eq 'nit' then begin

      Print, 'Reading fields for AMS Nitrate from file: '+file+' ...'

      s = 'Nitrate = ' + Platform + '.Nitrate'

      status = Execute( s )

      if (keyword_set(ppt)) then $
      ; Convert units from ug/m3 to ppt
      Data = ( 28.97 / (62.*1.29) ) * 1d3 * Nitrate $
      else $
      ; Convert units from ug/m3 to nmole/m3
      Data = ( 1. / 62. ) * 1d3 * nitrate

  ; Special Case for AMS Ammonium/Sulphate ratio
  endif else If field eq 'nh4_so4_ratio' then begin

      Print, 'Reading fields for AMS Ammonium & Sulphate from file: '+file

      s = 'ammonium = ' + Platform + '.Ammonium'

      status = Execute( s )

      s = 'sulphate = ' + Platform + '.Sulphate'

      status = Execute( s )

      ; Calculate molar ratio
      Data = ( 96./18. ) * ( ammonium/sulphate )

  endif else If field eq 'oc' then begin

      Print, 'Reading OC from file: '+file

      s = 'oc = ' + Platform + '.organicslt_213mz'

      status = Execute( s )

      ; Convert from ug C/m3 to ug/m3
      Data = oc / 1.8

  endif else begin

      ;----------
      ; All fields except DOY & SOx read here
      ;----------
 
      Print, 'Reading '+field+' from file: '+file+'  ...'
 
      ; Form a string tha reads the field from the desired platform
      s = 'Data = ' + Platform + '.' + field 
      status = Execute( s )  
 
  endelse

  ; When requested data don't exist, give the user a message and return 0
  if ( status eq 0 ) then begin
     print,'******* No field data for '+strupcase(field)
     return, 0
  endif
 
  return, Data
end
 
;==============================================================
;==============================================================

function get_field_data_arctas, Field_in, Platforms_in, FlightDates_in, $
                                avgtime=avgtime, NoCities=NoCities,       $
                                Troposphere=Troposphere, ppt=ppt, nss=nss
  
  ; Rename the internal variables to avoid changing the parameters
  ; that are passed in
  If Keyword_Set( Field_in ) then $
     Field       = Field_in
  If Keyword_Set( Platforms_in ) then $
     Platform    = Platforms_in
  If Keyword_Set( FlightDates_in ) then $
     FlightDates = FlightDates_in
  If n_elements( avgtime ) eq 0 then avgtime='60m'

  ; Directories containing 60s merges from NASA
  ; and averages over GEOS-Chem grid and time resolution 
  If avgtime='60s' then mrgDir='merge_60s' $
  else mrgDir = 'merge_'+avgtime+'_2x25' 

  ; Error message informs user of correct usage 
  If n_params() eq 0 then $
    message, 'usage: DATA = GET_FIELD_DATA_ARCTAS( FIELD, PLATFORM, '+$
             'FLIGHTDATES )'

  ; Default values for optional parameters 
  If n_params() eq 1 then $
    PLATFORM = 'DC8'
  If n_params() eq 2 then $
    FlightDates = '*'

    If StrMatch( Platform[0], 'DC8', /fold_case ) then begin
 
      ; Flightdates can be set as 'FAIRBANKS','CARB', or 'COLDLAKE'
      ; fairbanks_ams is to be used instead of fairbanks when using AMS
      ; observations, which had problems on the first 2 flights
      If strlowcase(FlightDates_in[0]) eq 'fairbanks' then begin
         Flightdates = ['20080401','20080404','20080405','20080408',$
                        '20080409','20080412','20080416','20080417',$
                        '20080419']
      endif else if strlowcase(Flightdates_in[0]) eq 'fairbanks_ams' then begin 
         Flightdates = ['20080405','20080408','20080409','20080412',$
			'20080416','20080417','20080419']
      endif else if strlowcase(Flightdates_in[0]) eq 'carb' then begin 
         Flightdates = ['20080618','20080620','20080622','20080624',$
                        '20080626']
      endif else if strlowcase(Flightdates_in[0]) eq 'coldlake' then begin 
         Flightdates = ['20080626','20080629','20080701','20080704',$
                        '20080705','20080708','20080709','20080710',$
                        '20080713']

      endif
 
    endif else if StrMatch( Platform[0], 'P3B', /fold_case ) then begin
      If strlowcase(FlightDates_in[0]) eq 'fairbanks' then begin
         Flightdates = ['20080331','20080401','20080406','20080408',$
                        '20080409','20080413','20080415','20080419' ]
      endif else if strlowcase(Flightdates_in[0]) eq 'carb' then begin 
         Flightdates = ['20080622','20080624','20080626']
      endif else if strlowcase(Flightdates_in[0]) eq 'coldlake' then begin 
         Flightdates = ['20080626','20080628','20080629','20080630',$
                        '20080702','20080703','20080706','20080707',$
			'20080709','20080712']
     endif
 
    endif
 ;--------------------------------------------------------------
  ; In order to read multiple dates or platforms
  ; we need to have equal length string arrays for PLATFORM and FLIGHTDATES.
  ; This section generates the correct length arrays if either argument
  ; is passed as a scalar (for shorthand)
  ;--------------------------------------------------------------

  ; Number of platforms (e.g. DC8, P3B) and flight dates
  ; Note that both Platforms and FlightDates can be '*'
  N_Platforms = n_elements( Platform )
  N_Dates     = n_elements( FlightDates )
  N_Entries   = 1
 
  ; If there are multiple flight dates, then we read the same platform
  ; for all dates
  If ( N_Platforms eq 1 ) and ( N_Dates gt 1 ) then begin
 
    Platform = Replicate( Platform, N_Dates )
    N_Entries = N_Dates
 
  endif

  ; If there are multiple platforms, then we read the same flight date
  ; for all platforms 
  If ( N_Dates eq 1 ) and ( N_Platforms gt 1 ) then begin
 
    FlightDates = Replicate( FlightDates, N_Platforms )
    N_Entries = N_Platforms
 
  endif

  ; If there are multiple platforms and multiple flight dates, then
  ; there need to be the same number of each. Error if they aren't equal
  ; length arrays
  If ( N_Platforms gt 1 ) and ( N_Dates gt 1 ) then begin
     If ( N_Dates ne N_Platforms ) then begin
        message, 'Platform and FlightDates must either be scalar strings, '+$
             'or have the same number of elements'
     endif else begin
           N_Entries = N_Dates
     endelse
  endif  
 
  ;--------------------------------------------------------------
  ; Find the files and Read the data
  ;
  ;--------------------------------------------------------------
 
  Files = StrArr( N_Entries ) 
 
  ; Initialize, Drop this element later
  Data = [0]
 
  ; Loop over the number of distinct Platforms or FlightDates
  ; Note: If FlightDates='*', then it's only one loop iteration here
  For i = 0, N_Entries-1L do begin

    ; The various aircraft platforms each have their own data 
    ; directory, which we define here 
    ; Find all of the files matching the FlightDates criteria
    If StrMatch( Platform[i], 'DC8', /fold_case ) then begin
 
      NewFiles = $
        MFindFile(!ARCTAS+'/field_data/DC8/'+mrgDir+$
                  '/*'+FlightDates[i]+'*.sav')
 
    endif else if StrMatch( Platform[i], 'P3B', /fold_case ) then begin
 
      NewFiles = $
        MFindFile(!ARCTAS+'/field_data/P3B/'+mrgDir+$
                  '/*'+FlightDates[i]+'*.sav')
    
    endif

      ; Loop over the number of files found
      ; Read the data from each
      For j = 0L, n_elements( NewFiles )-1L do begin

        NewData = read_file_field( NewFiles[j], Field, Platform[i], ppt=ppt )

        ; Concatenate the data if it is nonzero
        If ( n_elements( NewData ) gt 1 ) then $  
          Data = [ Data, NewData ] 
 
      endfor
 
  endfor
 
  
  ; Return NaN if no data were found, 
  ; otherwise drop the first element which is initialized to 0
  If ( n_elements( Data ) eq 1 ) then $
    return, !Values.f_nan else $ 
    Data = Data[1:*]

  ;--------------------------------------------------------------
  ; If keyword NoCities, then filter the data to remove observations
  ; near Fairbanks, Barrow and Prudhoe Bay (i.e. point sources)
  ;--------------------------------------------------------------
  If Keyword_Set( NoCities ) then begin
 
    ; We need to read latitude, longitude and altitude
    lat = get_field_data_arctas( 'lat', Platform, Flightdates, $
                                 avgtime=avgtime, hravg=hravg )
    lon = get_field_data_arctas( 'lon', Platform, Flightdates, $
                                 avgtime=avgtime, hravg=hravg )
    alt = get_field_data_arctas( 'alt', Platform, Flightdates, $
                                 avgtime=avgtime, hravg=hravg )
 
    ; In the following searches, we locate and exclude observations
    ; within 1.5 degrees of the source. 
    ; (At these latitudes, 1deg longitude = 20-25mi)
 
    ; Define the region near Fairbanks 
    ind_Fairbanks = where( abs( lat - 64.8         ) le 1.5 and $
                           abs( lon - (-147.9+360) ) le 1.5 and $
	                   alt le 2, $
                           complement=cind_Fairbanks )
 
    ; Define the region near Barrow
    ind_Barrow    = where( abs( lat - 76.5         ) le 1.5 and $
                           abs( lon - (-156.8+360) ) le 1.5 and $
	                   alt le 2, $
                           complement=cind_Barrow )
 
    ; Define the region near Prudhoe Bay 
    ind_PrudBay   = where( abs( lat - 70.3         ) le 1.5 and $
                           abs( lon - (-148.4+360) ) le 1.5 and $
	                   alt le 2, $
                           complement=cind_PrudBay )
 
    ; Find the intersection of all indices outside cities
    ind_noCities = cmset_op( cind_Fairbanks, 'AND', cind_Barrow  )
    ind_noCities = cmset_op( cind_PrudBay,   'AND', ind_noCities )
 
    ; Limit the data to points outside cities
    Data = Data[ind_noCities]
  
  endif
 
  ;--------------------------------------------------------------
  ; If keyword TROPOSPHERE, then exclude data where [O3]/[CO] > 1.25 
  ; 
  ;--------------------------------------------------------------
  If Keyword_Set( TROPOSPHERE ) then begin

    ; We need to read O3 and CO 
    CO = get_field_data_arctas( 'CO', Platform, Flightdates, $
                                 avgtime=avgtime, noCities=noCities, $
                                 hravg=hravg )
    O3 = get_field_data_arctas( 'O3', Platform, Flightdates, $
                                 avgtime=avgtime, noCities=noCities, $ 
                                 hravg=hravg )

    ind_troposphere = where( O3/CO le 1.25, count )

    If (count ge 1 ) then $
      Data = Data[ind_troposphere]
 
  endif
 
  ;--------------------------------------------------------------
  ; Return Data
  ;
  ;--------------------------------------------------------------
  return, Data
end
